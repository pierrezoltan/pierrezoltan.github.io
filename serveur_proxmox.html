<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serveur Proxmox &mdash; Documentation Documentation Projet Cluster Proxmox 0.1</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css\rtd_sphinx_search.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
        <script src="_static/js\rtd_sphinx_search.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="Switch 3COM" href="switch3com.html" />
    <link rel="prev" title="Récapitulatif des matériels et logiciels" href="recap.html" />
<style>
        .wy-side-nav-search .wy-dropdown > a img.logo, .wy-side-nav-search > a img.logo { width: 50%; height: 50%; }
</style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Documentation Projet Cluster Proxmox
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Sommaire :</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="recap.html"><strong>Récapitulatif des matériels et logiciels</strong></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#"><strong>Serveur Proxmox</strong></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#objectif-et-environnement">Objectif et environnement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#objectif">Objectif</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environnement">Environnement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#documentation">Documentation :</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-prealable">Configuration préalable</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#processus">Processus</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creation-dun-cluster">Création d’un Cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installation-ceph">Installation Ceph</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ajout-des-monitors-et-managers">Ajout des Monitors et Managers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creation-dun-pool-de-stockage">Création d’un pool de stockage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creation-dun-pool">Création d’un pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mise-en-place-de-la-haute-disponibilite-ha">Mise en place de la haute disponibilité (HA)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-de-la-migration-dune-vm">Test de la migration d’une VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-de-la-haute-disponibilite-lors-dune-coupure-dun-serveur">Test de la haute disponibilité lors d’une coupure d’un serveur</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#suppression-dun-cluster">Suppression d’un cluster</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="switch3com.html"><strong>Switch 3COM</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="active_directory.html"><strong>Serveur Active Directory</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="nagios.html"><strong>Serveur NAGIOS</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="pfsense.html"><strong>Serveur pfSense</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="veeam.html"><strong>Serveur VEEAM Backup</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="exchange.html"><strong>Serveur Exchange 2019</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="cups.html"><strong>Serveur CUPS (impression)</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="glpi.html"><strong>Serveur GLPI</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="samba.html"><strong>Serveur SAMBA</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="zabbix.html"><strong>Serveur Zabbix</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="truenas.html"><strong>TrueNAS</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="lamp.html"><strong>Serveur WEB (LAMP)</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="freepbx.html"><strong>FreePBX</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="ocs.html"><strong>Serveur OCS</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="pingcastle.html"><strong>PingCastle</strong></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Documentation Projet Cluster Proxmox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li><strong>Serveur Proxmox</strong></li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/serveur_proxmox.md.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="serveur-proxmox">
<h1><strong>Serveur Proxmox</strong><a class="headerlink" href="#serveur-proxmox" title="Lien permanent vers cette rubrique"></a></h1>
<section id="objectif-et-environnement">
<h2>Objectif et environnement<a class="headerlink" href="#objectif-et-environnement" title="Lien permanent vers cette rubrique"></a></h2>
<section id="objectif">
<h3>Objectif<a class="headerlink" href="#objectif" title="Lien permanent vers cette rubrique"></a></h3>
<p>Installation et configuration d’un cluster Proxmox avec trois serveurs en haute disponibilité sur serveurs. Tolérance de panne d’un serveur.</p>
</section>
<section id="environnement">
<h3>Environnement<a class="headerlink" href="#environnement" title="Lien permanent vers cette rubrique"></a></h3>
<p>Matériels :</p>
<ul class="simple">
<li><p>3 x Dell PowerEdge r240 avec Proxmox 7.1-7</p></li>
</ul>
<p>Adressage des VMS :</p>
<ul class="simple">
<li><p>Réseau interne : 172.16.0.0/16</p></li>
<li><p>IP internes : 172.28.1.250, 172.28.1.250, 172.28.1.250</p></li>
<li><p>Réseau externe : 192.168.10.xx/26 (en DHCP fournie par le PEI)</p></li>
</ul>
</section>
<section id="documentation">
<h3>Documentation :<a class="headerlink" href="#documentation" title="Lien permanent vers cette rubrique"></a></h3>
<p><a class="reference external" href="https://www.youtube.com/watch?app=desktop&amp;amp;v=Y-n73ciSsZw">https://www.youtube.com/watch?app=desktop&amp;v=Y-n73ciSsZw</a></p>
</section>
<section id="configuration-prealable">
<h3>Configuration préalable<a class="headerlink" href="#configuration-prealable" title="Lien permanent vers cette rubrique"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p><strong>Nous allons utiliser des disques formattés en Ceph pour la haut disponibilité. Ces disques doivent être non RAID ou RAID0 à 1 disque, sinon Ceph ne pourra pas s’installer.</strong></p>
</div>
</section>
</section>
<section id="processus">
<h2>Processus<a class="headerlink" href="#processus" title="Lien permanent vers cette rubrique"></a></h2>
<section id="creation-dun-cluster">
<h3>Création d’un Cluster<a class="headerlink" href="#creation-dun-cluster" title="Lien permanent vers cette rubrique"></a></h3>
<p>Nous avons créé un cluster sur le 1<sup>er</sup>
serveur (172.28.1.250/16) :</p>
<img alt="_images/image5.png" src="_images/image5.png" />
<p>Nommé le cluster puis create :</p>
<p><img alt="_images/image6.png" src="_images/image6.png" /></p>
<p>Le cluster a été correctement créé :</p>
<p><img alt="_images/image7.png" src="_images/image7.png" /></p>
<p>Une fois le cluster créé, nous avons copié join information (clé
d’agrégation)</p>
<p><img alt="_images/image8.png" src="_images/image8.png" /></p>
<p>Sur le 2<sup>e</sup> serveur (pve2 : 172.28.1.251/16)</p>
<p>Menu Cluster &gt; Joindre le cluster</p>
<p><img alt="_images/image9.png" src="_images/image9.png" /></p>
<p>Le serveur est bien arrivé sur le cluster. Nous avons fait la même
manipulation pour le 3<sup>e</sup> serveur (172.28.1.252/16).</p>
<p><img alt="_images/image10.png" src="_images/image10.png" /></p>
<section id="installation-ceph">
<h4>Installation Ceph<a class="headerlink" href="#installation-ceph" title="Lien permanent vers cette rubrique"></a></h4>
<p>Installation Ceph sur les serveurs</p>
<p>Menu &gt; Ceph</p>
<p><img alt="_images/image11.png" src="_images/image11.png" /></p>
<p><img alt="_images/image12.png" src="_images/image12.png" /></p>
<p><img alt="_images/image13.png" src="_images/image13.png" /></p>
<p>Nous avons installé Ceph sur les deux autres serveurs également.</p>
<p><img alt="_images/image14.png" src="_images/image14.png" /></p>
<p><img alt="_images/image15.png" src="_images/image15.png" /></p>
</section>
<section id="ajout-des-monitors-et-managers">
<h4>Ajout des Monitors et Managers<a class="headerlink" href="#ajout-des-monitors-et-managers" title="Lien permanent vers cette rubrique"></a></h4>
<p>Cette fonctionnalité donne des droits pour afficher et manager les
différents serveurs Proxmox.</p>
<p>Menu &gt; Ceph &gt; Monitor</p>
<p><img alt="_images/image16.png" src="_images/image16.png" /></p>
<p><img alt="_images/image17.png" src="_images/image17.png" /></p>
<p><img alt="_images/image18.png" src="_images/image18.png" /></p>
<p><img alt="_images/image19.png" src="_images/image19.png" /></p>
<p><img alt="_images/image20.png" src="_images/image20.png" /></p>
</section>
<section id="creation-dun-pool-de-stockage">
<h4>Création d’un pool de stockage<a class="headerlink" href="#creation-dun-pool-de-stockage" title="Lien permanent vers cette rubrique"></a></h4>
<p>Menu Ceph &gt; OSD &gt; Create OSD</p>
<p><img alt="_images/image21.png" src="_images/image21.png" /></p>
<p><img alt="_images/image22.png" src="_images/image22.png" /></p>
<p>Nous avons effectué la même manipulation sur les deux autres serveurs.</p>
<p><img alt="_images/image23.png" src="_images/image23.png" /></p>
</section>
<section id="creation-dun-pool">
<h4>Création d’un pool<a class="headerlink" href="#creation-dun-pool" title="Lien permanent vers cette rubrique"></a></h4>
<p>Menu &gt; Ceph &gt; Pools</p>
<p><img alt="_images/image24.png" src="_images/image24.png" /></p>
<p><img alt="_images/image25.png" src="_images/image25.png" /></p>
<p>Ceph stockage a été créé.</p>
</section>
<section id="mise-en-place-de-la-haute-disponibilite-ha">
<h4>Mise en place de la haute disponibilité (HA)<a class="headerlink" href="#mise-en-place-de-la-haute-disponibilite-ha" title="Lien permanent vers cette rubrique"></a></h4>
<p>Menu &gt; HA &gt; Groups</p>
<p><img alt="_images/image26.png" src="_images/image26.png" /></p>
<p><img alt="_images/image27.png" src="_images/image27.png" /></p>
<p><img alt="_images/image28.png" src="_images/image28.png" /></p>
</section>
<section id="test-de-la-migration-dune-vm">
<h4>Test de la migration d’une VM<a class="headerlink" href="#test-de-la-migration-dune-vm" title="Lien permanent vers cette rubrique"></a></h4>
<p>Nous avons créé un conteneur test sur le pve1</p>
<p><img alt="_images/image29.png" src="_images/image29.png" /></p>
<p>Nous avons ajouté le conteneur dans la haute disponibilité pve1-ha</p>
<p><img alt="_images/image30.png" src="_images/image30.png" /></p>
<p><img alt="_images/image31.png" src="_images/image31.png" /></p>
<p>Nous avons arrêté le pve1.</p>
<p><img alt="_images/image32.png" src="_images/image32.png" /></p>
<p>Le conteneur est bien arrivé sur le pv3. Par la suite nous avons rallumé
pve1.</p>
<p><img alt="_images/image33.png" src="_images/image33.png" /></p>
<p>Le conteneur est retourné automatiquement sur pve1(3 min après avoir
démarré pv1).</p>
</section>
<section id="test-de-la-haute-disponibilite-lors-dune-coupure-dun-serveur">
<h4>Test de la haute disponibilité lors d’une coupure d’un serveur<a class="headerlink" href="#test-de-la-haute-disponibilite-lors-dune-coupure-dun-serveur" title="Lien permanent vers cette rubrique"></a></h4>
<p>Nous avons lancé une copie d’un fichier volumineux à partir de la
partition D:\ du l’AD sur le pve1 vers un dossier partage se trouvant
sur le serveur SAMBA sur le pve3.</p>
<p><img alt="_images/image34.png" src="_images/image34.png" /><img alt="_images/image35.png" src="_images/image35.png" /></p>
<p><img alt="_images/image36.png" src="_images/image36.png" /></p>
<p>En paralelle, nous avons lancé un ping continue depuis CLI-DEB-01 sur
pve3 vers <a class="reference external" href="http://www.google.com">www.google.com</a>. Le client accède à
l’internet via FW-PROXY se trouvant sur le pve1.</p>
<p><img alt="_images/image37.png" src="_images/image37.png" /></p>
<p><strong>NB</strong> : chaque VM possède un snapshot avec sa dernière bonne
configuration. Lors d’une migration, la VM bascule avec son snapshot !</p>
<p>Configuration des groupes HA</p>
<p><img alt="_images/image38.png" src="_images/image38.png" /></p>
<p>Ajout des ressources pour effectuer le test</p>
<p><img alt="_images/image39.png" src="_images/image39.png" /></p>
<p><img alt="_images/image40.png" src="_images/image40.png" /></p>
<p>Etape1</p>
<p><img alt="_images/image41.png" src="_images/image41.png" /></p>
<p><img alt="_images/image42.png" src="_images/image42.png" /></p>
<p>Les VM sont arrivées sur le pve3</p>
<p><img alt="_images/image43.png" src="_images/image43.png" /></p>
<p><img alt="_images/image44.png" src="_images/image44.png" /></p>
<p><img alt="_images/image45.png" src="_images/image45.png" /></p>
<p>Nous avons rejoué la séquence en rebranchent le pve1</p>
<p><img alt="_images/image46.png" src="_images/image46.png" /></p>
<p><strong>Etape2</strong></p>
<p>Les VM AD et PROXY sont en état <strong>migrate</strong></p>
<p><img alt="_images/image47.png" src="_images/image47.png" /></p>
<p>Pendant la copie la migration du l’AD n’a pas été effective.</p>
<p><strong>Etape 3</strong></p>
<p>Pf a basculé complètement sans aucune coupure</p>
<p><img alt="_images/image48.png" src="_images/image48.png" /></p>
<p><img alt="_images/image49.png" src="_images/image49.png" /></p>
<p><strong>Etape 4</strong></p>
<p>Fin de la copie du fichier depuis l’AD vers le partage SAMBA.</p>
<p><img alt="_images/image50.png" src="_images/image50.png" /></p>
<p>Pendant la migration l’AD continue fournir des services, notamment la
résolution DNS. L’AD est toujours 100% fonctionnel.</p>
<p><img alt="_images/image51.png" src="_images/image51.png" /></p>
<p><strong>Etape 5</strong></p>
<p>La migration du l’AD est effective</p>
<p><img alt="_images/image52.png" src="_images/image52.png" /></p>
</section>
</section>
<section id="suppression-dun-cluster">
<h3>Suppression d’un cluster<a class="headerlink" href="#suppression-dun-cluster" title="Lien permanent vers cette rubrique"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl stop corosync pve-cluster  
pmxcfs -l  
rm -rf /etc/corosync/<span class="se">\*</span>  
rm -rf /etc/pve/corosync.conf  
killall pmxcfs  
systemctl start pve-cluster
</pre></div>
</div>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Lien permanent vers cette rubrique"></a></h2>
<p>La mise en place d’un cluster est terminée. Les images concernées par la
haute disponibilité doivent être crées sur la partition répliquée prévue
à cette effet(ceph-stockage).</p>
<p>Sur Proxmox il y a une différence notable entre migration voulu ou
depuis et vers un serveur actif et migration automatique suite d’une
panne. Dans le premier cas (reprise d’activités), nous n’avons pas
constaté de coupure de service. La migration est plus lente. Lors de la
simulation d’une panne la migration est automatique avec des coupures de
service, néanmoins la migration est plus rapide.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="recap.html" class="btn btn-neutral float-left" title="Récapitulatif des matériels et logiciels" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="switch3com.html" class="btn btn-neutral float-right" title="Switch 3COM" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Pierre Bonnenfant &amp; Zoltan Sram.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
        .wy-nav-content { max-width: none;}
        .rst-content {width: 800px;}
         /* .wy-nav-content { max-width: 800px;margin-left:auto;margin-right: auto;} */
         /*.wy-nav-content-wrap { max-width: none;}*/
  </style>



</body>
</html>